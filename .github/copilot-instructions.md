# Dota 2 Addon with Solid-JS Panorama UI

This is a Dota 2 custom game addon using Solid-JS for Panorama UI development with TypeScript compilation for both UI and VScripts.

## Architecture Overview

**Dual Build Pipeline:**
1. **Panorama UI**: Solid-JS/TSX → Babel (with custom presets) → Rollup → Panorama JS/XML/CSS
2. **VScripts**: TypeScript → TypeScript-to-Lua (TSTL) → Lua files → Optional AES encryption

**Critical Build Flow:**
- `rollup/build.ts` orchestrates the entire Panorama build process
- `rollup/build-rollup-config.ts` configures Rollup with 8+ custom plugins
- Custom Babel preset `@bigciba/babel-preset-solid-panorama` transforms JSX for Panorama compatibility
- Plugin chain: Babel → XML generation → LESS compilation → Polyfill merging → Manifest generation

**Key Directories:**
- `src/ui/`: TSX components organized by type (hud_main, tooltips, context_menus, custom_loading_screen)
- `src/polyfill/`: Custom polyfills merged by `plugin-polyfill.ts` (index.ts, enums.ts)
- `src/manifest_scripts/`: Scripts injected into manifest (compiled TS/JS copied to output)
- `src/declarations/`: TypeScript definitions for Panorama/Dota 2 APIs (panel.d.ts, elements.d.ts, etc.)
- `content/{addon_name}/panorama/`: Build output (layout/, scripts/, styles/ subdirs)
- `game/{addon_name}/scripts/vscripts/`: Compiled Lua scripts

## Essential Development Workflows

**Build Commands:**
```bash
npm run dev:solid        # Watch & rebuild Panorama UI on changes
npm run build:solid      # One-time Panorama UI build
npm run dev:vscripts     # Watch & compile TypeScript to Lua
npm run build:vscripts   # One-time VScripts build
npm run encrypt:vscripts # Encrypt Lua files using AES (key from package.json encryption.key)
```

**Adding New UI Components:**
1. Add component name to `package.json` → `panorama` section under appropriate type (Hud/Tooltip/ContextMenu)
2. Create `src/ui/{type}/{name}/{name}.tsx` (TSX component)
3. Create `src/ui/{type}/{name}/{name}.less` (styles)
4. XML file is auto-generated by `rollup-plugin-xml.ts` if not present
5. Build system detects files by checking `existsSync(path.join(pagesUrl, ${v.name}/${v.name}.tsx))`

**Manifest Scripts:**
Files listed in `panorama.ManifestScripts` array are compiled (TS→JS) and injected into `custom_ui_manifest.xml`. Used for early initialization code before main components load.

## Project-Specific Patterns

**Component Registration:**
Components are NOT imported/exported traditionally. Instead:
- Each `.tsx` file calls `render()` from `@bigciba/solid-panorama-runtime` at the top level
- Example: `render(HudMain, $.GetContextPanel())` in `hud_main.tsx`
- Component types in package.json determine output paths (tooltips/ vs context_menus/ subdirs)

**Triple-File Pattern:**
Each UI component produces three files in output:
- `{name}.tsx` → `{name}.js` (Solid component compiled to Panorama-compatible JS)
- `{name}.less` → `{name}.css` (LESS compiled with imports resolved)
- `{name}.xml` (auto-generated layout or user-provided)

**Custom Polyfill System:**
- Files listed in `panorama.Polyfill` array are merged into single `panorama-polyfill.js`
- TS files transpiled using TypeScript compiler (not Babel) to ES5
- Output included FIRST in manifest before all other scripts
- Custom `SymbolSpliter` utility function in `src/polyfill/index.ts`

**XML/CSS Macro System:**
- Imports from `solid-panorama-all-in-jsx/xml.macro` and `/css.macro`
- `getAllCacheXML()` and `getAllCacheCSS()` gather styles/markup from TSX files
- Plugins merge cached content across entire module graph via `ctx.getModuleInfo(id).importedIds`
- This enables writing styles/markup inline in TSX that get extracted to separate files

**Code Chunking Strategy:**
Manual chunk splitting in `build-rollup-config.ts`:
- `common`: Files matching `/common/` path pattern
- `libs`: node_modules + rollup helpers + inject_modules
- Prevents duplicate Solid runtime across chunks

**Global CustomUIConfig Pattern:**
Cross-component communication via globals attached to `CustomUIConfig`:
```typescript
declare global {
  interface CustomUIConfig {
    showContextMenu: (panel: Panel, menus: Record<string, Function>, offset?: [number, number]) => void;
  }
}
CustomUIConfig.showContextMenu = (panel, menus, offset) => { /* impl */ };
```
Used in `context_menus.tsx` for popup positioning system.

## Integration Points

**Panorama Type System:**
- Custom augmented types in `src/declarations/panel.d.ts` extend base Panorama types
- Example: `PanelBase.SetPanelEvent(event: CustomPanelEvent, handler)` adds 'onblur' event
- `Panel.Data<T>()` typed accessor for panel data
- Use `@moddota/panorama-types` as base, extended locally

**VScripts Encryption:**
- AES encryption via `node_scripts/encrypt-custom-game.js`
- Requires 32-char hex key in `package.json` → `encryption.key`
- `SERVER_MODULE_PATTERNS` excludes init files and specific modules from encryption
- Optional minification via `luamin` (controlled by `MINIFY_PATTERNS`)

**Babel Configuration:**
Preset order matters in `build-rollup-config.ts`:
```javascript
presets: [
  ['@babel/preset-env', { targets: { node: '18.12' } }],
  '@babel/preset-typescript',
  ['@bigciba/babel-preset-solid-panorama', { moduleName: '@bigciba/solid-panorama-runtime', generate: 'universal' }]
]
```
Plugin: `babel-plugin-macros` enables XML/CSS macro extraction

**Solid Runtime:**
- Custom fork: `@bigciba/solid-panorama-runtime` (not standard solid-js)
- Precompiled runtime in `rollup/solid-core.js` copied to output by `build.ts`
- Generate mode set to 'universal' for Panorama compatibility

**Watch System:**
Rollup plugins use `this.addWatchFile()` to track:
- LESS files corresponding to TSX entries
- Manifest scripts from `src/manifest_scripts/`
- Polyfill source files
- Imported LESS dependencies resolved via custom `resolveImport()`

## Common Debugging Patterns

**Build Failures:**
- Check `content/{addon_name}/` directory exists (build.ts validates this first)
- Verify `package.json` name matches folder structure
- Color-coded console output: Panorama (magenta), Tooltips (cyan), ContextMenus (yellow)

**Type Errors:**
- Panorama globals defined in `src/declarations/*.d.ts`
- `$.GetContextPanel()` returns `Panel` type
- Game-specific types in `content/solid_template/declarations/` (custom_net_tables.d.ts, netdata.d.ts)

**Path Resolution:**
All paths normalized with `normalizedPath()` utility (converts backslashes to forward slashes)
Build outputs are relative to addon name: `content/${addonName}/panorama/`