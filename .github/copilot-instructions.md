# Dota 2 Addon with Solid-JS Panorama UI

This is a Dota 2 custom game addon using Solid-JS for Panorama UI development with TypeScript compilation for both UI and VScripts.

## Architecture Overview

**Dual Build Pipeline:**
1. **Panorama UI**: Solid-JS/TSX ‚Üí Babel (with custom presets) ‚Üí Rollup ‚Üí Panorama JS/XML/CSS
2. **VScripts**: TypeScript ‚Üí TypeScript-to-Lua (TSTL) ‚Üí Lua files ‚Üí Optional AES encryption

**Critical Build Flow:**
- `rollup/build.ts` orchestrates the entire Panorama build process and copies `solid-core.js` to output
- `rollup/build-rollup-config.ts` configures Rollup with 10+ custom plugins
- Custom Babel preset `@bigciba/babel-preset-solid-panorama` transforms JSX for Panorama compatibility
- Plugin chain: Babel ‚Üí XML generation ‚Üí LESS compilation ‚Üí Polyfill merging ‚Üí Manifest generation ‚Üí Libs injection ‚Üí Save fresh

**Key Directories:**
- `src/ui/`: TSX components organized by type (hud_main, hud_menu_bar, custom_loading_screen, context_menus)
- `src/components/`: Reusable UI components (e.g., `EOMDesign/Input/EOM_Button/`)
- `src/polyfill/`: Custom polyfills merged by `plugin-polyfill.ts` (index.ts, enums.ts)
- `src/manifest_scripts/`: Scripts injected into manifest (compiled TS/JS copied to output)
- `src/declarations/`: TypeScript definitions for Panorama/Dota 2 APIs (panel.d.ts, common.d.ts, etc.)
- `content/{addon_name}/panorama/`: Build output (layout/, scripts/, styles/ subdirs)
- `content/{addon_name}/scripts/vscripts/`: TypeScript source for VScripts (tsconfig.json here)
- `game/{addon_name}/scripts/vscripts/`: Compiled Lua scripts output
- `rollup/inject_modules/`: Runtime and universal modules injected by plugin-libs-inject

## Essential Development Workflows

**Build Commands:**
```bash
npm run dev:solid        # Watch & rebuild Panorama UI on changes
npm run build:solid      # One-time Panorama UI build
npm run dev:vscripts     # Watch & compile TypeScript to Lua (with auto-cleanup)
npm run build:vscripts   # One-time VScripts build
npm run dev:vscripts:basic # TSTL watch only (no cleanup)
npm run encrypt:vscripts # Encrypt Lua files using AES (key from package.json encryption.key)
npm run clean:images     # Clean unused images
```

**Adding New UI Components:**
1. Add component name to `package.json` ‚Üí `panorama` section under appropriate type (Hud/Tooltip/ContextMenu)
2. Create `src/ui/{type}/{name}/{name}.tsx` (TSX component)
3. Create `src/ui/{type}/{name}/{name}.less` (styles)
4. XML file is auto-generated by `rollup-plugin-xml.ts` if not present
5. Build system detects files by checking `existsSync(path.join(pagesUrl, ${v.name}/${v.name}.tsx))`

**Manifest Scripts:**
Files listed in `panorama.ManifestScripts` array are compiled (TS‚ÜíJS) and injected into `custom_ui_manifest.xml`. Used for early initialization code before main components load. Examples: `request.js`, `click.js`, `init.js`, `red_point.js`, `netdata.js`, `test.ts`

**VScripts Watch System:**
`dev:vscripts` uses `node_scripts/watch-vscripts.js` which:
- Spawns TSTL compiler in watch mode
- Uses chokidar to monitor source file deletions
- Auto-deletes corresponding `.lua` files when `.ts` files are removed
- Converts paths from `content/solid_template/scripts/vscripts/*.ts` ‚Üí `game/solid_template/scripts/vscripts/*.lua`

## Project-Specific Patterns

**Component Registration:**
Components are NOT imported/exported traditionally. Instead:
- Each `.tsx` file calls `render()` from `@bigciba/solid-panorama-runtime` at the top level
- Example: `render(HudMain, $.GetContextPanel())` in `hud_main.tsx`
- Component types in package.json determine output paths (tooltips/ vs context_menus/ subdirs)

**Triple-File Pattern:**
Each UI component produces three files in output:
- `{name}.tsx` ‚Üí `{name}.js` (Solid component compiled to Panorama-compatible JS)
- `{name}.less` ‚Üí `{name}.css` (LESS compiled with imports resolved)
- `{name}.xml` (auto-generated layout or user-provided)

**Custom Polyfill System:**
- Files listed in `panorama.Polyfill` array are merged into single `panorama-polyfill.js`
- TS files transpiled using TypeScript compiler (not Babel) to ES5
- Output included FIRST in manifest before all other scripts
- Helper functions like `SymbolSpliter(content, symbol1, symbol2)` available in `src/polyfill/index.ts`
- SaveData/LoadData helpers for panel data management

**XML/CSS Macro System:**
- Imports from `solid-panorama-all-in-jsx/xml.macro` and `/css.macro` (currently not used in codebase but available)
- `getAllCacheXML()` and `getAllCacheCSS()` gather styles/markup from TSX files
- Plugins merge cached content across entire module graph via `ctx.getModuleInfo(id).importedIds`
- This enables writing styles/markup inline in TSX that get extracted to separate files

**Code Chunking Strategy:**
Manual chunk splitting in `build-rollup-config.ts`:
- `common`: Files matching `/common/` path pattern
- `libs`: node_modules + rollup helpers + inject_modules
- Prevents duplicate Solid runtime across chunks

**Global CustomUIConfig Pattern:**
Cross-component communication via globals attached to `CustomUIConfig`:
```typescript
declare global {
  interface CustomUIConfig {
    showContextMenu: (panel: Panel, menus: Record<string, Function>, offset?: [number, number]) => void;
  }
}
CustomUIConfig.showContextMenu = (panel, menus, offset) => { /* impl */ };
```
Used in `context_menus.tsx` for popup positioning system with smart viewport collision detection.

**Reusable Component Pattern:**
Components in `src/components/` (e.g., `EOMDesign/Input/EOM_Button/`) follow standard Solid.js patterns:
- Use `useSimpleProps()` helper from `src/utils/component-helpers.ts` to simplify props handling
- Pattern combines: default values (mergeProps) + property splitting (splitProps) + class merging (classNames)
- Example usage:
```typescript
const { local, others } = useSimpleProps(props, {
  defaultValues: { color: "Purple", size: "Normal" },
  localKeys: ["color", "size", "icon", "children"] as const,
  componentClass: "EOM_Button"  // Auto-merges with props.class
});
return <Button {...others}>{local.icon}{local.children}</Button>;
```
- Use `ParentComponent<T>` for components with children
- LESS files co-located with components
- Component default class is automatically merged with passed-in class prop
- See `src/utils/component-helpers-examples.tsx` for comprehensive usage patterns

**Panorama CSS/LESS Restrictions:**
Dota 2 Panorama engine has specific CSS limitations that differ from standard web CSS:
- ‚ö†Ô∏è **NO shorthand properties**: Must use longhand versions
  - ‚ùå `transition: all 0.3s ease` ‚Üí ‚úÖ `transition-property: all; transition-duration: 0.3s; transition-timing-function: ease;`
  - ‚ùå `animation: spin 1s linear infinite` ‚Üí ‚úÖ `animation-name: spin; animation-duration: 1s; animation-timing-function: linear; animation-iteration-count: infinite;`
  - ‚ùå `background: url(...) no-repeat center` ‚Üí ‚úÖ `background-image: url(...); background-repeat: no-repeat; background-position: center;`
- üéØ **Always separate CSS properties** in LESS files for Panorama compatibility
- üìù Example from `EOM_Button.less`:
```less
// ‚úÖ Correct - Longhand properties
transition-property: brightness, color;
transition-duration: 0.05s;
transition-timing-function: ease-in-out;

// ‚ùå Wrong - Shorthand (won't work in Panorama)
transition: brightness 0.05s ease-in-out, color 0.05s ease-in-out;
```
- Common properties requiring expansion: `transition`, `animation`, `background`, `border`, `margin`, `padding`, `font`

## Integration Points

**Panorama Type System:**
- Custom augmented types in `src/declarations/panel.d.ts` extend base Panorama types
- Example: `PanelBase.SetPanelEvent(event: CustomPanelEvent, handler)` adds 'onblur' event
- `Panel.Data<T>()` typed accessor for panel data
- `Panel.FindChild<T>()` returns typed panel references
- `TooltipPanel.GetTooltipTarget<T>()` for tooltip target access
- Use `@moddota/panorama-types` as base, extended locally

**VScripts Encryption:**
- AES encryption via `node_scripts/encrypt-custom-game.js`
- Requires 32-char hex key in `package.json` ‚Üí `encryption.key`
- `SERVER_MODULE_PATTERNS` excludes init files and specific modules from encryption:
  - `init`, `addon_game_mode_client`, `addon_game_mode`
  - `triggers/*`, `entities/*`, `units/*`
  - `lualib_bundle`, `requires`, `lib/tstl-utils`
- Optional minification via `luamin` (controlled by `MINIFY_PATTERNS`)
- Injects AES decryption script from `node_scripts/aes.lua`

**Babel Configuration:**
Preset order matters in `build-rollup-config.ts`:
```javascript
presets: [
  ['@babel/preset-env', { targets: { node: '18.12' } }],
  '@babel/preset-typescript',
  ['@bigciba/babel-preset-solid-panorama', { moduleName: '@bigciba/solid-panorama-runtime', generate: 'universal' }]
]
```
Plugins: `@babel/plugin-transform-typescript`, `babel-plugin-macros`

**Solid Runtime:**
- Custom fork: `@bigciba/solid-panorama-runtime` (not standard solid-js)
- Precompiled runtime in `rollup/solid-core.js` copied to output by `build.ts`
- Generate mode set to 'universal' for Panorama compatibility
- Standard Solid.js features available: signals, effects, Show, For, batch, etc.

**Watch System:**
Rollup plugins use `this.addWatchFile()` to track:
- LESS files corresponding to TSX entries
- Manifest scripts from `src/manifest_scripts/`
- Polyfill source files
- Imported LESS dependencies resolved via custom `resolveImport()`

**Plugin Execution Order:**
1. `babel()` - Transform JSX/TypeScript
2. `alias()` - Resolve @common/ imports
3. `replace()` - Environment variables (NODE_ENV)
4. `commonjs()` - CommonJS to ES modules
5. `nodeResolve()` - Resolve node_modules
6. `compatiblePanorama()` - Panorama-specific transformations
7. `rollupPluginXML()` - Generate XML from cached macro data
8. `GenerateXML()` - Generate XML layouts with filename resolution
9. `rollupPluginLess()` - Compile LESS to CSS with imports
10. `GeneratePolyfill()` - Merge polyfill files
11. `GenerateCustomUIManifest()` - Create custom_ui_manifest.xml
12. `fixLibs()` - Inject runtime/universal modules
13. `SaveFresh()` - Final cleanup/save operations

## Common Debugging Patterns

**Build Failures:**
- Check `content/{addon_name}/` directory exists (build.ts validates this first)
- Verify `package.json` name matches folder structure
- Color-coded console output: Panorama (magenta), Tooltips (cyan), ContextMenus (yellow), Commons (green)
- Watch for "üìÅ solid-core.js Â∑≤Â§çÂà∂Âà∞Ëá™ÂÆö‰πâÊ∏∏ÊàèÁõÆÂΩï" message on startup

**Type Errors:**
- Panorama globals defined in `src/declarations/*.d.ts`
- `$.GetContextPanel()` returns `Panel` type
- Game-specific types in `content/solid_template/declarations/` if they exist
- Custom attributes like `EOM_ButtonAttribute` extend `PanelAttributes`

**Path Resolution:**
- All paths normalized with `normalizedPath()` utility (converts backslashes to forward slashes)
- Build outputs are relative to addon name: `content/${addonName}/panorama/`
- VScripts output: `game/${addonName}/scripts/vscripts/`
- Use forward slashes in all configuration paths

**VScripts Issues:**
- Source files in `content/solid_template/scripts/vscripts/`
- Compiled output in `game/solid_template/scripts/vscripts/`
- Check tsconfig.json in vscripts directory for TSTL configuration
- Watch mode (`dev:vscripts`) includes automatic cleanup of orphaned Lua files
- Encryption excludes init files and specific modules (see SERVER_MODULE_PATTERNS)

**Component Not Rendering:**
- Ensure component is added to `package.json` panorama section
- Check that `.tsx`, `.less`, and `.xml` files exist (XML can be auto-generated)
- Verify `render()` is called at top level with correct panel target
- Look for build errors in color-coded console output
- Confirm output files exist in `content/{addon_name}/panorama/`
