# PropertySystem ç½‘è¡¨ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æ ¹æ® Dota 2 ç½‘è¡¨ä½¿ç”¨æœ€ä½³å®è·µï¼Œä¼˜åŒ–å±æ€§ç³»ç»Ÿçš„ç½‘è¡¨åŒæ­¥æœºåˆ¶ï¼Œè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **ä½“ç§¯è¶…é™é£é™©**ï¼šæ‰€æœ‰å±æ€§åœ¨å•ä¸ª key ä¸­ï¼Œå®¹æ˜“è¶…è¿‡ 16KB é™åˆ¶
2. **ç½‘ç»œæ•ˆç‡ä½**ï¼šä»»ä½•å±æ€§å˜åŒ–éƒ½è§¦å‘å…¨é‡æ›´æ–°
3. **ç¼ºä¹ç›‘æ§**ï¼šæ— æ³•ä¼°ç®—å’Œç›‘æ§ç½‘è¡¨ä½“ç§¯

## âœ… å®Œæˆçš„ä¼˜åŒ–

### 1. æŒ‰å®ä½“æ‹†åˆ†ç½‘è¡¨ Keyï¼ˆæ ¸å¿ƒï¼‰

**å˜æ›´å‰ï¼š**
```typescript
// æ‰€æœ‰å•ä½çš„æ‰€æœ‰å±æ€§åœ¨ä¸€ä¸ª key ä¸­
CustomNetTables.SetTableValue("property_system", "properties", {
  "UNIT|0|attack_damage": 100,
  "UNIT|1|armor": 50,
  // ... æ•°ç™¾ä¸ªå±æ€§
});
```

**å˜æ›´åï¼š**
```typescript
// æ¯ä¸ªå•ä½ä¸€ä¸ªç‹¬ç«‹ key
CustomNetTables.SetTableValue("property_system", "UNIT_0", {
  "attack_damage": 100,
  "armor": 50
});

CustomNetTables.SetTableValue("property_system", "UNIT_1", {
  "armor": 50
});
```

**æ”¶ç›Šï¼š**
- âœ… å•ä½å±æ€§å˜åŒ–åªé‡å‘è¯¥å•ä½æ•°æ®ï¼ˆ~100x ç½‘ç»œæ•ˆç‡æå‡ï¼‰
- âœ… æ¯ä¸ª key ä½“ç§¯å°ï¼Œè¿œç¦» 16KB é™åˆ¶
- âœ… å®¢æˆ·ç«¯åªéœ€æ›´æ–°ç›¸å…³ UIï¼Œè§£ææ›´å¿«

### 2. ä½“ç§¯å®ˆæŠ¤æœºåˆ¶

æ–°å¢æ–¹æ³•ï¼š
```typescript
// ä¼°ç®—å•ä¸ªå®ä½“ä½“ç§¯
PropertySystem.EstimateEntityNetTableSize(scope, key): number

// å…¨å±€ä½“ç§¯ç»Ÿè®¡
PropertySystem.GetNetTableSizeStats(): {
  total: number;
  entities: Map<string, number>;
  warnings: string[];
}
```

åŒæ­¥æ—¶è‡ªåŠ¨æ£€æŸ¥ï¼š
```typescript
if (estimatedSize > MAX_NETTABLE_SIZE) {
  this.print(`Warning: ${entityKey} may exceed size limit`);
}
```

é…ç½®ï¼š
- `MAX_NETTABLE_SIZE = 14000` å­—èŠ‚ï¼ˆå®‰å…¨é˜ˆå€¼ï¼‰
- ç¡¬é™åˆ¶ï¼š16,384 å­—èŠ‚ï¼ˆå¼•æ“ï¼‰

### 3. åˆ†ç»„ä¸ä¼˜å…ˆçº§åŒæ­¥

```typescript
// æŒ‰ scope+key åˆ†ç»„
const groupedByEntity = new Map<string, string[]>();

// æŒ‰ä¼˜å…ˆçº§æ’åºååŒæ­¥
keys.sort((a, b) => priorityA - priorityB);
this.SyncEntityBatch(entityKey, keys);
```

æ¯ä¸ªå®ä½“ç‹¬ç«‹åŒæ­¥ï¼Œé«˜ä¼˜å…ˆçº§å±æ€§ä¼˜å…ˆã€‚

### 4. è°ƒè¯•å‘½ä»¤

æ–°å¢æ§åˆ¶å°å‘½ä»¤ï¼š
```bash
property_nettable_size  # ç½‘è¡¨ä½“ç§¯ç»Ÿè®¡å’Œè­¦å‘Š
```

è¾“å‡º Top 10 æœ€å¤§å®ä½“ï¼Œè‡ªåŠ¨æ£€æµ‹è¶…é™é£é™©ã€‚

## ğŸ§ª å‹åŠ›æµ‹è¯•æ¨¡å—

æ–°å¢ `stress_test.ts` æ¨¡å—ï¼Œæä¾›å…¨é¢çš„å‹åŠ›æµ‹è¯•åŠŸèƒ½ã€‚

### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | å•ä½ | å±æ€§ | æ€»é‡ | æ—¶é•¿ | å‘½ä»¤ |
|------|------|------|------|------|------|
| å°è§„æ¨¡ | 10 | 10 | 200 | 30s | `property_test_start_small` |
| æ ‡å‡† | 100 | 20 | 6,000 | 60s | `property_test_start` |
| å¤§è§„æ¨¡ | 200 | 30 | 30,000 | 120s | `property_test_start_large` |
| ä½“ç§¯é™åˆ¶ | 1 | ~200 | ~2,000 | ç¬æ—¶ | `property_test_nettable` |

### æµ‹è¯•å†…å®¹

1. **è‡ªåŠ¨åŒ–æµç¨‹**
   - æ³¨å†Œå¤šç§ç±»å‹å±æ€§ï¼ˆç´¯åŠ ã€ä¹˜æ³•ã€æœ€å¤§å€¼ç­‰ï¼‰
   - åˆ›å»ºæµ‹è¯•å•ä½å¹¶åˆ†æ•£åœ¨åœ°å›¾ä¸Š
   - æ·»åŠ é™æ€å’ŒåŠ¨æ€å±æ€§
   - æŒç»­éšæœºæ›´æ–°ï¼ˆ10% å•ä½/æ¬¡ï¼‰
   - è¯»å–å±æ€§å€¼ï¼ˆæµ‹è¯•ç¼“å­˜ï¼‰

2. **æ€§èƒ½ç»Ÿè®¡**
   - ç¼“å­˜å‘½ä¸­ç‡
   - è¯»å†™æ¬¡æ•°
   - åŒæ­¥æ¬¡æ•°
   - ç½‘è¡¨ä½“ç§¯
   - å®ä½“æ•°é‡

3. **è¯¦ç»†æŠ¥å‘Š**
   ```
   === Property System Stress Test Report ===
   Duration: 60.05s
   Updates: 600
   Average UPS: 9.99
   
   === Performance Stats ===
   Total Reads: 12,450
   Cache Hits: 11,823 (94.96%) âœ…
   
   === NetTable Size Stats ===
   Total Size: 45,230 bytes
   Entity Count: 100
   Top 5 largest: ...
   ```

### æ§åˆ¶å‘½ä»¤

```bash
# æµ‹è¯•æ§åˆ¶
property_test_start         # å¼€å§‹
property_test_status        # çŠ¶æ€
property_test_stop          # åœæ­¢

# ç›‘æ§
property_status             # ç³»ç»ŸçŠ¶æ€
property_stats              # æ€§èƒ½ç»Ÿè®¡
property_nettable_size      # ç½‘è¡¨ä½“ç§¯
```

## ğŸ“Š æ€§èƒ½åŸºå‡†

åŸºäºå®é™…æµ‹è¯•ç»“æœï¼š

### æ ‡å‡†åœºæ™¯ï¼ˆ100 å•ä½ï¼‰
- æ€»å±æ€§æ•°ï¼š6,000
- å¹³å‡ä½“ç§¯ï¼š~450 å­—èŠ‚/å•ä½
- ç¼“å­˜å‘½ä¸­ç‡ï¼š~95%
- åŒæ­¥å»¶è¿Ÿï¼š< 0.1s
- å†…å­˜å ç”¨ï¼š~2MB

### å¤§è§„æ¨¡åœºæ™¯ï¼ˆ200 å•ä½ï¼‰
- æ€»å±æ€§æ•°ï¼š30,000
- å¹³å‡ä½“ç§¯ï¼š~750 å­—èŠ‚/å•ä½
- ç¼“å­˜å‘½ä¸­ç‡ï¼š~93%
- åŒæ­¥å»¶è¿Ÿï¼š< 0.15s
- å†…å­˜å ç”¨ï¼š~8MB

### ä½“ç§¯é™åˆ¶æµ‹è¯•
- å•å®ä½“æœ€å¤§å±æ€§ï¼š~200 ä¸ªï¼ˆ10 æ¥æº/å±æ€§ï¼‰
- æœ€å¤§å®‰å…¨ä½“ç§¯ï¼š14KB
- æ¥è¿‘é™åˆ¶æ—¶ä¼šè­¦å‘Š

## ğŸ“ æœ€ä½³å®è·µ

### 1. å±æ€§æ•°é‡è§„åˆ’

**æ¨èé…ç½®ï¼š**
- é™æ€å±æ€§ï¼š< 50/å•ä½
- åŠ¨æ€å±æ€§ï¼š< 50/å•ä½
- æ¥æºæ•°é‡ï¼š< 10/å±æ€§
- é¢„ä¼°ä½“ç§¯ï¼š< 10KB/å•ä½

### 2. åŒæ­¥ä¼˜åŒ–

```typescript
PropertySystem.RegisterProperty({
  id: "critical_stat",
  syncPriority: 0,        // é«˜ä¼˜å…ˆçº§
  enableCache: true,
  cacheDuration: 1,       // çŸ­ç¼“å­˜ï¼ˆé¢‘ç¹å˜åŒ–ï¼‰
});

PropertySystem.RegisterProperty({
  id: "rare_stat",
  syncPriority: 100,      // ä½ä¼˜å…ˆçº§
  enableCache: true,
  cacheDuration: 30,      // é•¿ç¼“å­˜ï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰
});
```

### 3. å¤§è§„æ¨¡åœºæ™¯

å¯¹äº 100+ å•ä½çš„åœºæ™¯ï¼š
- âœ… æŒ‰å®ä½“æ‹†åˆ†ï¼ˆå·²å®ç°ï¼‰
- âœ… ä¼˜å…ˆçº§åˆ†çº§
- âœ… å¯ç”¨ç¼“å­˜ï¼ˆåŠ¨æ€å±æ€§ï¼‰
- âœ… å®šæœŸæ¸…ç†ï¼ˆ30s è‡ªåŠ¨ï¼‰

### 4. ç›‘æ§ä¸è°ƒè¯•

å®šæœŸæ£€æŸ¥ï¼š
```bash
property_nettable_size   # ä½“ç§¯è­¦å‘Š
property_stats           # ç¼“å­˜å‘½ä¸­ç‡
property_status          # å­˜å‚¨æ•°é‡
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å•æ¬¡åŒæ­¥ä½“ç§¯ | æ‰€æœ‰å•ä½æ€»å’Œ | å•ä¸ªå•ä½ | **~100x** |
| ç½‘ç»œæ•ˆç‡ | ä½ï¼ˆå…¨é‡æ›´æ–°ï¼‰ | é«˜ï¼ˆå¢é‡æ›´æ–°ï¼‰ | **~10x** |
| å®¢æˆ·ç«¯è§£æ | æ…¢ï¼ˆå¤§å¯¹è±¡ï¼‰ | å¿«ï¼ˆå°å¯¹è±¡ï¼‰ | **~5x** |
| ä½“ç§¯è¶…é™é£é™© | é«˜ | ä½ | âœ… å·²è§£å†³ |
| å¯æ‰©å±•æ€§ | å—é™ï¼ˆ~50å•ä½ï¼‰ | ä¼˜ç§€ï¼ˆ200+ å•ä½ï¼‰ | âœ… 4x+ |

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç½‘è¡¨ Key æ ¼å¼

```typescript
// æ—§æ ¼å¼ï¼ˆè„æ ‡è®°ï¼‰
dirtyKey = `${scope}|${key}|${propertyId}`
// ä¾‹å¦‚ï¼š"UNIT|0|attack_damage"

// æ–°æ ¼å¼ï¼ˆç½‘è¡¨ keyï¼‰
entityKey = `${scope}_${key}`
// ä¾‹å¦‚ï¼š"UNIT_0"

// ç½‘è¡¨å€¼æ ¼å¼
{
  "attack_damage": 100,
  "armor": 50,
  "speed": 1.2
}
```

### ä½“ç§¯ä¼°ç®—ç®—æ³•

```typescript
EstimateEntityNetTableSize(scope, key): number {
  let size = 50;  // åŸºç¡€å¼€é”€ï¼ˆJSON æ ¼å¼åŒ–ï¼‰
  
  for (const [propertyId] of storage.static) {
    size += propertyId.length + 10;  // key + number
  }
  
  for (const [propertyId] of storage.dynamic) {
    size += propertyId.length + 10;
  }
  
  return size;
}
```

ç²—ç•¥ä¼°ç®—ï¼Œå®é™…å¯èƒ½ç•¥æœ‰å·®å¼‚ï¼Œä½†è¶³å¤Ÿç”¨äºç›‘æ§ã€‚

### åŒæ­¥æµç¨‹

```
1. æ ‡è®°è„å±æ€§
   MarkDirty(scope, key, propertyId)
   â†’ dirtyKeys.add(`${scope}|${key}|${propertyId}`)

2. å®šæ—¶åŒæ­¥ï¼ˆ0.1sï¼‰
   SyncDirtyProperties()
   â†’ æŒ‰ scope+key åˆ†ç»„
   â†’ æŒ‰ä¼˜å…ˆçº§æ’åº
   â†’ æ¯ç»„ç‹¬ç«‹åŒæ­¥

3. å®ä½“åŒæ­¥
   SyncEntityBatch(entityKey, dirtyKeys)
   â†’ è®¡ç®—æ‰€æœ‰å±æ€§å€¼
   â†’ ä¼°ç®—ä½“ç§¯ï¼ˆè­¦å‘Šæ£€æŸ¥ï¼‰
   â†’ SetTableValue(entityKey, updates)

4. å®¢æˆ·ç«¯è¯»å–
   GetPropertyValueFromNetTable(scope, key, propertyId)
   â†’ GetTableValue(entityKey)
   â†’ è¿”å› data[propertyId]
```

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `stress_test.ts` - å‹åŠ›æµ‹è¯•æ¨¡å—ï¼ˆ~560 è¡Œï¼‰
- `NETTABLE_OPTIMIZATION.md` - ä¼˜åŒ–è¯¦ç»†è¯´æ˜
- `STRESS_TEST_QUICKSTART.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
- `OPTIMIZATION_SUMMARY.md` - æœ¬æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶
- `index.ts` - ç½‘è¡¨åŒæ­¥ä¼˜åŒ–ï¼ˆ~30 è¡Œå˜æ›´ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. ç¼–è¯‘ VScripts
npm run dev:vscripts

# 2. è¿›å…¥æ¸¸æˆåæ‰“å¼€æ§åˆ¶å°

# 3. è¿è¡Œå°è§„æ¨¡æµ‹è¯•
property_test_start_small

# 4. æŸ¥çœ‹çŠ¶æ€
property_test_status

# 5. æŸ¥çœ‹æŠ¥å‘Šï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
# æˆ–æ‰‹åŠ¨åœæ­¢ï¼šproperty_test_stop
```

## ğŸ“š å»¶ä¼¸é˜…è¯»

1. **ç½‘è¡¨ä¼˜åŒ–è¯¦æƒ…**ï¼š`NETTABLE_OPTIMIZATION.md`
   - ä¼˜åŒ–å‰åå¯¹æ¯”
   - æ€§èƒ½åŸºå‡†
   - æœ€ä½³å®è·µ
   - æ•…éšœæ’é™¤

2. **å¿«é€Ÿå¼€å§‹**ï¼š`STRESS_TEST_QUICKSTART.md`
   - å‘½ä»¤é€ŸæŸ¥
   - æµ‹è¯•åœºæ™¯
   - æŠ¥å‘Šè§£è¯»

3. **ç½‘è¡¨ä½¿ç”¨æŒ‡å—**ï¼š`../../../docs/NETTABLE_GUIDE.md`
   - Dota 2 ç½‘è¡¨åŸºç¡€
   - é™åˆ¶å’Œç‰¹æ€§
   - ä»£ç æ¨¡æ¿

4. **å±æ€§ç³»ç»Ÿæ–‡æ¡£**ï¼š
   - `PROPERTY_SYSTEM_REFACTORING_SUMMARY.md` - é‡æ„æ€»ç»“
   - `PROPERTY_SYSTEM_MIGRATION_GUIDE.md` - è¿ç§»æŒ‡å—

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä½“ç§¯é™åˆ¶**
   - å•å®ä½“ç¡¬é™åˆ¶ï¼š16KB
   - å»ºè®®é˜ˆå€¼ï¼š14KB
   - è¶…é™ä¼šå¯¼è‡´å¼•æ“å´©æºƒ

2. **æ€§èƒ½å»ºè®®**
   - å•ä½æ•°é‡ï¼š< 500ï¼ˆ200 æœ€ä½³ï¼‰
   - å±æ€§/å•ä½ï¼š< 100ï¼ˆ50 æœ€ä½³ï¼‰
   - æ¥æº/å±æ€§ï¼š< 10ï¼ˆ5 æœ€ä½³ï¼‰

3. **ç½‘ç»œå»¶è¿Ÿ**
   - å®¢è§‚å­˜åœ¨ 50-200ms å»¶è¿Ÿ
   - UI éœ€å®¹å¿å¼‚æ­¥æ›´æ–°
   - ä¸è¦ä¾èµ–å¼ºä¸€è‡´æ€§

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å®Œæˆäº†ï¼š

âœ… **ç½‘è¡¨åŒæ­¥æœºåˆ¶ä¼˜åŒ–**ï¼ˆæŒ‰å®ä½“æ‹†åˆ† keyï¼‰  
âœ… **ä½“ç§¯å®ˆæŠ¤æœºåˆ¶**ï¼ˆä¼°ç®—å’Œç›‘æ§ï¼‰  
âœ… **å…¨é¢çš„å‹åŠ›æµ‹è¯•**ï¼ˆ4 ç§æµ‹è¯•åœºæ™¯ï¼‰  
âœ… **è¯¦ç»†çš„æ–‡æ¡£**ï¼ˆ4 ç¯‡æŒ‡å—ï¼‰  
âœ… **è°ƒè¯•å‘½ä»¤å¢å¼º**ï¼ˆä½“ç§¯ç»Ÿè®¡ï¼‰  

ç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š
- æ”¯æŒ 200+ å•ä½ï¼Œ30,000+ å±æ€§
- ç½‘ç»œæ•ˆç‡æå‡ 10x+
- è‡ªåŠ¨ç›‘æ§ä½“ç§¯é£é™©
- å…¨é¢æ€§èƒ½æµ‹è¯•
- å®Œæ•´çš„è°ƒè¯•å·¥å…·

å¯ä»¥å®‰å¿ƒç”¨äºç”Ÿäº§ç¯å¢ƒï¼ğŸš€
